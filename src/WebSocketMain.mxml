<?xml version="1.0" encoding="utf-8"?>
<s:Application xmlns:fx="http://ns.adobe.com/mxml/2009" 
			   xmlns:s="library://ns.adobe.com/flex/spark" 
			   xmlns:mx="library://ns.adobe.com/flex/mx" minWidth="955" minHeight="600"
			   creationComplete="application1_creationCompleteHandler(event)">
	<s:layout>
		<s:VerticalLayout />
	</s:layout>
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
	</fx:Declarations>
	<fx:Script>
		<![CDATA[
			
			import flash.display.*;
			import flash.events.*;
			import flash.external.*;
			import flash.net.*;
			import flash.system.*;
			import flash.utils.*;
			
			import mx.controls.*;
			import mx.core.*;
			import mx.events.*;
			import mx.utils.*;
			
			
			private var callerUrl:String;
			private var debug:Boolean = true;
			private var manualPolicyFileLoaded:Boolean = false;
			
			private var socket:WebSocket;
			
			public function setCallerUrl(url:String):void {
				callerUrl = url;
			}
			
			public function setDebug(val:Boolean):void {
				debug = val;
			}
			
			public function create(
				url:String, protocol:String,
				proxyHost:String = null, proxyPort:int = 0,
										 headers:String = null):WebSocket {
				if (!manualPolicyFileLoaded) {
					loadDefaultPolicyFile(url);
				}
				return new WebSocket(this, url, protocol, proxyHost, proxyPort, headers);
			}
			
			public function getOrigin():String {
				return (URLUtil.getProtocol(this.callerUrl) + "://" +
					URLUtil.getServerNameWithPort(this.callerUrl)).toLowerCase();
			}
			
			public function getCallerHost():String {
				return URLUtil.getServerName(this.callerUrl);
			}
			
			private function loadDefaultPolicyFile(wsUrl:String):void {
				var policyUrl:String = "xmlsocket://" + URLUtil.getServerName(wsUrl) + ":843";
				log("policy file: " + policyUrl);
				Security.loadPolicyFile(policyUrl);
			}
			
			public function loadManualPolicyFile(policyUrl:String):void {
				log("policy file: " + policyUrl);
				Security.loadPolicyFile(policyUrl);
				manualPolicyFileLoaded = true;
			}
			
			public function log(message:String):void {
				if (debug) {
					//ExternalInterface.call("webSocketLog", encodeURIComponent("[WebSocket] " + message));
					trace(message);
				}
			}
			
			public function error(message:String):void {
				ExternalInterface.call("webSocketError", encodeURIComponent("[WebSocket] " + message));
			}
			
			public function fatal(message:String):void {
				ExternalInterface.call("webSocketError", encodeURIComponent("[WebSocket] " + message));
				throw message;
			}

			protected function application1_creationCompleteHandler(event:FlexEvent):void
			{
				callerUrl = "http://localhost:8124/WebSocketMain.html";
				socket = create('ws://192.168.0.3:8124/socket.io/flashsocket', null);
				
			}

		]]>
	</fx:Script>
	
	<s:TextInput id="text" />
	<s:Button label="send" click="socket.send(text.text)" />
</s:Application>
